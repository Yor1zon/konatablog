# KONATABLOG 软件架构文档

## 项目概述

KONATABLOG是一个基于Spring Boot的轻量级个人博客系统，采用经典的分层架构设计，支持Markdown写作、主题定制和图片托管功能。

**技术栈**：
- Spring Boot 3.5.7
- Java 17
- Spring Data JPA + Hibernate
- SQLite数据库
- Spring Security + BCrypt
- Lombok

## 架构层次

```
┌─────────────────────────────────────────┐
│           Controller Layer             │  (REST API - 待实现)
├─────────────────────────────────────────┤
│            Service Layer               │  (业务逻辑层 - 4/7完成)
├─────────────────────────────────────────┤
│           Repository Layer             │  (数据访问层 - ✅完成)
├─────────────────────────────────────────┤
│            Entity Layer                │  (实体模型层 - ✅完成)
├─────────────────────────────────────────┤
│           Database Layer               │  (SQLite - ✅配置完成)
└─────────────────────────────────────────┘
```

## 核心模块分析

### 1. 应用入口 (KonatablogApplication.java)

- **位置**: `src/main/java/wiki/kana/KonatablogApplication.java:6`
- **功能**: Spring Boot应用启动入口
- **调用链**: `main()` → `SpringApplication.run()`

### 2. 实体层 (Entity Layer)

**位置**: `src/main/java/wiki/kana/entity/`

#### 核心实体类：

**User.java** - 用户实体
- **主要属性**: id, username, password, role, isActive
- **实体关系**:
  - `@OneToMany` → Media (mediaList)
  - `@OneToMany` → Post (posts)
- **关键方法**: `updateLastLoginAt()` (User.java:117)

**Post.java** - 博客文章实体
- **主要属性**: id, title, slug, content, status, viewCount
- **实体关系**:
  - `@ManyToOne` ← User (author)
  - `@ManyToOne` ← Category (category)
  - `@ManyToMany` ↔ Tag (tags)
  - `@OneToOne` ← Media (bannerImage)
- **关键方法**:
  - `incrementViewCount()` (Post.java:139)
  - `publish()` (Post.java:146)
  - `isPublished()` (Post.java:164)

### 3. 数据访问层 (Repository Layer)

**位置**: `src/main/java/wiki/kana/repository/`

**已实现Repository**:
- `UserRepository` - 用户数据访问，支持自定义查询
- `PostRepository` - 文章数据访问，支持搜索和分页
- `CategoryRepository` - 分类数据访问
- `TagRepository` - 标签数据访问
- `MediaRepository` - 媒体文件数据访问
- `SettingsRepository` - 配置数据访问
- `ThemesRepository` - 主题数据访问

### 4. 业务逻辑层 (Service Layer)

**位置**: `src/main/java/wiki/kana/service/`

#### 已实现服务 (4/7)：

**UserService.java** (480行) - 用户管理服务
- **依赖**: UserRepository, PasswordEncoder
- **核心功能**:
  - 用户CRUD操作
  - 用户认证: `authenticate()` (UserService.java:318)
  - 密码加密: `createUser()` (UserService.java:149)
  - 用户状态管理: `activateUser()`, `deactivateUser()` (UserService.java:259,277)
- **调用链**: Controller → UserService.authenticate() → UserRepository.findByUsername() → PasswordEncoder.matches()

**PostService.java** (369行) - 文章管理服务
- **依赖**: PostRepository, UserRepository, CategoryRepository, TagRepository
- **核心功能**:
  - 文章CRUD操作
  - 发布流程: `publishPost()` (PostService.java:158)
  - 搜索功能: `searchByKeyword()` (PostService.java:93)
  - 浏览量统计: `incrementViewCount()` (PostService.java:238)
- **调用链**: Controller → PostService.publishPost() → PostRepository.save()

**CategoryService.java** - 分类管理服务
- **依赖**: CategoryRepository
- **核心功能**: 分类层次结构、自动slug生成

**TagService.java** - 标签管理服务
- **依赖**: TagRepository
- **核心功能**: 标签关联管理、使用统计、相关推荐

#### 待实现服务 (3/7):
- MediaService - 媒体文件管理
- SettingsService - 系统配置管理
- ThemesService - 主题管理

### 5. 安全配置 (Security Layer)

**SecurityConfig.java** - Spring Security配置
- **位置**: `src/main/java/wiki/kana/config/SecurityConfig.java:12`
- **核心功能**: BCrypt密码编码器配置 (SecurityConfig.java:24)
- **调用链**: UserService → PasswordEncoder.encode()

## 主要调用链分析

### 用户认证流程
```
用户请求 → SecurityFilter (待实现)
→ UserService.authenticate(username,password)
→ UserRepository.findByX()
→ PasswordEncoder.matches()
→ 用户实体返回
```

### 文章发布流程
```
Controller请求 (待实现)
→ PostService.createPost(post,authorId)
→ UserRepository.findById() 验证作者
→ PostRepository.save() 保存文章
→ TagRepository.findOrCreate() 处理标签
```

### 搜索功能流程
```
Controller.searchRequest(keyword)
→ PostService.searchByKeyword(keyword)
→ PostRepository.searchByTitle() + searchByContent()
→ 结果去重和返回
```

## 数据库关系模型

```sql
users (1) ──────── (∞) posts
users (1) ──────── (∞) media
categories (1) ─── (∞) posts
posts (∞) ───────── (∞) tags (多对多)
posts (1) ───────── (∞) media (多对多)
```

## 异常处理机制

**自定义异常**:
- `ResourceNotFoundException` - 资源未找到
- `DuplicateResourceException` - 重复资源

**使用示例**:
```java
return userRepository.findById(id)
    .orElseThrow(() -> new ResourceNotFoundException("User not found"));
```

## 配置和依赖管理

### 数据库配置
- **位置**: `application.properties`
- **数据库**: SQLite (data/konatablog.db)
- **方言**: SQLiteDialect
- **DDL模式**: update

### 主要依赖
- Spring Boot Web/JPA/Security
- SQLite JDBC驱动
- Hibernate Community Dialects
- Lombok (代码生成)
- JWT (待集成)

## 开发状态

**已完成模块** ✅:
- 实体层 (7个实体类)
- 仓库层 (7个Repository接口)
- 服务层 (4/7个服务类: UserService, PostService, CategoryService, TagService)
- 安全配置 (BCrypt密码编码)

**待完成模块** 🔄:
- 服务层剩余3个服务 (MediaService, SettingsService, ThemesService)
- REST API控制器层
- JWT认证集成
- 前端集成

## 架构优势

1. **分层清晰**: 严格的分层架构，职责分离明确
2. **依赖注入**: Spring DI容器管理组件生命周期
3. **事务管理**: 声明式事务确保数据一致性
4. **类型安全**: 强类型实体和Repository接口
5. **可扩展性**: 基于接口的设计便于扩展和测试

## 技术债务和建议

1. **Controller Layer**: 需要实现REST API端点
2. **缓存机制**: 可考虑引入Redis缓存热点数据
3. **异步处理**: 文件上传等IO操作可异步化
4. **测试覆盖**: 需要补充集成测试和性能测试
5. **监控日志**: 需要完善应用监控和日志聚合