# 图片存储与显示（Markdown 占位符 + 附件表 + OSS 公共读）设计文档

## 1. 方案确定

### 1.1 头像（直接 URL）

- 图片上传至 OSS（公共读），得到 `url`。
- 后端将该 `url` 保存到用户表 `avatar_url`（或现有字段）。
- 前端渲染时直接使用 `<img src="{avatarUrl}">`。

### 1.2 插图（Markdown 占位符 + 附件表）

- 文章内容 `Post.content` 中不直接写图片 URL，而是写占位符：
  - `{{image:apple}}`：文章附件（与当前文章绑定）
  - `{{image::iphone}}`：全局附件（站点级别，可复用）（暂时不需要实现）
- 前端渲染文章时解析占位符，从后端获取“占位符 key -> 图片 URL”的映射，使用组件渲染为图片。
- 后端负责维护映射关系（附件表），图片文件本身存 OSS（公共读）。

## 2. 占位符规则

### 2.1 语法

- 文章附件：`{{image:<key>}}`
- 全局附件：`{{image::<key>}}`（暂时不需要实现）

### 2.2 key 约束

- 建议只允许：字母/数字/下划线/短横线（例如 `apple`、`iphone_15`、`banner-1`）
- 建议长度：1～64
- 建议统一小写（便于管理）

### 2.3 前端解析与渲染约定

- 前端扫描文章 Markdown 内容，收集所有占位符 key（区分文章附件与全局附件）。
- 前端调用后端接口批量获取 URL 映射。
- 前端用组件渲染：占位符替换为 `<img src="...">`（可附带 alt/title 等元数据）。
- 若 key 未找到映射：按“缺失资源”展示占位符（例如灰底提示）或直接隐藏（由前端统一策略决定）。

## 3. 数据模型（后端管理映射）

> 图片文件依然存 OSS；表里只存“规则 key 与图片资源”的绑定关系。

### 3.1 文章附件表（建议新增）

表：`post_attachments`

- `id`
- `post_id`
- `key`（占位符 key，文章内唯一）
- `url`（OSS 公网 URL）或 `object_key`（OSS key）
- `alt_text`（可选）
- `created_by` / `created_at` / `updated_at`（可选）

### 3.2 全局附件表（可选，支持 {{image::key}}）（暂时不需要实现）

表：`global_attachments`

- `id`
- `key`（全局唯一）
- `url` 或 `object_key`
- `alt_text`（可选）
- `created_by` / `created_at` / `updated_at`（可选）

备注：如果项目暂时不需要全局附件，可以先不建该表，只实现 `{{image:key}}`。

## 4. 接口（前端直传 + 后端落库）

### 4.1 获取直传 OSS 凭证

`POST /api/oss/upload-credentials`

用途：前端上传前获取签名，并由后端分配本次上传的 `objectKey`。

请求建议包含：

- `type`: `"avatar"` / `"post-attachment"` / `"global-attachment"`
- `postId`: 可选（文章附件时）
- `fileName` / `contentType` / `size`

响应建议包含：

- `uploadHost`、`objectKey`、`policy`、`signature`、`expireAt`
- `publicUrl`（后端按 bucket/endpoint 直接拼出来，便于前端后续落库）

### 4.2 头像保存

`POST /api/users/me/avatar`

- 前端直传 OSS 成功后，调用该接口把 `publicUrl` 写入用户资料。

### 4.3 文章附件绑定（建立 key -> url 映射）

`PUT /api/posts/{postId}/attachments`

请求（JSON，示例）：

```json
{
  "key": "apple",
  "url": "https://<bucket>.<endpoint>/posts/123/20251227/uuid.png",
  "altText": "苹果图片"
}
```

### 4.4 获取文章附件映射（用于渲染）

`GET /api/posts/{postId}/attachments`

响应建议返回：

- `items`: `{ key, url, altText }[]`

或直接返回 map：`{ "apple": "https://..." }`（由前端渲染实现选择）。

### 4.5 获取全局附件映射（可选）

`GET /api/attachments/global?keys=iphone,logo`

返回全局 key -> url 的映射，供前端解析 `{{image::key}}` 使用。

## 5. OSS 配置要点（公共读 + 直传）

- Bucket ACL：Public Read
- 配置 CORS：允许前端域名进行 `POST/PUT/OPTIONS`，并放行必要 header
