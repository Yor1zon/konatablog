## 需求分析

- 需要实现的：
  - 在文章编辑页的tag设置区搜索tag时：
    - 当tag存在时，能够搜索并选择使用已有的tag，不区分大小写
    - 在tag不存在时，能够按默认参数创建一个tag
  - 在tag设置页：
    - 能够通过搜索框搜索已有的tag，不区分大小写
    - 显示有多少文章关联tag
    - 在关联文章数量旁边设置按钮，用一个弹窗显示有哪些文章关联了此tag，并支持增删操作

## RESTful API 接口设计

### 1. 标签搜索与智能创建接口

#### 1.1 优化标签搜索（支持不区分大小写）

```http
GET /api/tags/search
```

**参数：**
- `q` (query, string): 搜索关键词
- `page` (query, int, default=0): 页码
- `size` (query, int, default=20): 每页大小
- `ignoreCase` (query, boolean, default=true): 是否忽略大小写

**响应示例：**
```json
{
  "success": true,
  "data": {
    "content": [
      {
        "id": 1,
        "name": "JavaScript",
        "slug": "javascript",
        "description": "JavaScript编程语言",
        "usageCount": 15,
        "postCount": 15,
        "color": "#f7df1e",
        "createdAt": "2024-01-01T10:00:00",
        "updatedAt": "2024-01-01T10:00:00"
      }
    ],
    "page": 0,
    "size": 20,
    "totalElements": 1,
    "totalPages": 1
  }
}
```

#### 1.2 智能标签创建接口

```http
POST /api/tags/smart-create
```

**请求体：**
```json
{
  "name": "Vue.js",
  "description": "Vue.js框架技术",
  "color": "#4FC08D"
}
```

**逻辑说明：**
1. 首先按名称查找（不区分大小写）
2. 如果找到则返回现有标签
3. 如果未找到则创建新标签

**响应示例：**
```json
{
  "success": true,
  "message": "标签创建成功",
  "data": {
    "id": 2,
    "name": "Vue.js",
    "slug": "vue-js",
    "description": "Vue.js框架技术",
    "usageCount": 0,
    "postCount": 0,
    "color": "#4FC08D",
    "createdAt": "2024-01-01T10:00:00",
    "updatedAt": "2024-01-01T10:00:00"
  }
}
```

### 2. 文章标签关联管理接口

#### 2.1 添加单个标签到文章

```http
POST /api/posts/{postId}/tags/{tagId}
```

**路径参数：**
- `postId` (long): 文章ID
- `tagId` (long): 标签ID

**响应示例：**
```json
{
  "success": true,
  "message": "标签添加成功"
}
```

#### 2.2 从文章移除单个标签

```http
DELETE /api/posts/{postId}/tags/{tagId}
```

**路径参数：**
- `postId` (long): 文章ID
- `tagId` (long): 标签ID

**响应示例：**
```json
{
  "success": true,
  "message": "标签移除成功"
}
```

#### 2.3 批量设置文章标签

```http
PUT /api/posts/{postId}/tags
```

**请求体：**
```json
{
  "tagIds": [1, 2, 3]
}
```

**响应示例：**
```json
{
  "success": true,
  "message": "标签设置成功",
  "data": {
    "id": 1,
    "title": "我的文章",
    "tags": [
      {
        "id": 1,
        "name": "JavaScript",
        "slug": "javascript"
      },
      {
        "id": 2,
        "name": "Vue.js",
        "slug": "vue-js"
      }
    ]
  }
}
```

### 3. 标签关联文章管理接口

#### 3.1 获取标签关联文章简要信息

```http
GET /api/tags/{tagId}/posts-summary
```

**路径参数：**
- `tagId` (long): 标签ID

**查询参数：**
- `page` (query, int, default=0): 页码
- `size` (query, int, default=10): 每页大小
- `status` (query, string, optional): 文章状态筛选

**响应示例：**
```json
{
  "success": true,
  "data": {
    "content": [
      {
        "id": 1,
        "title": "Vue.js入门教程",
        "slug": "vue-js-tutorial",
        "excerpt": "Vue.js基础入门...",
        "status": "PUBLISHED",
        "createdAt": "2024-01-01T10:00:00"
      }
    ],
    "page": 0,
    "size": 10,
    "totalElements": 15,
    "totalPages": 2
  }
}
```

#### 3.2 批量添加文章到标签

```http
POST /api/tags/{tagId}/posts
```

**请求体：**
```json
{
  "postIds": [1, 2, 3]
}
```

**响应示例：**
```json
{
  "success": true,
  "message": "批量添加成功，共添加3篇文章"
}
```

#### 3.3 批量从标签移除文章

```http
DELETE /api/tags/{tagId}/posts
```

**请求体：**
```json
{
  "postIds": [1, 2, 3]
}
```

**响应示例：**
```json
{
  "success": true,
  "message": "批量移除成功，共移除3篇文章"
}
```

### 4. 优化现有接口

#### 4.1 修改标签建议接口

```http
GET /api/tags/suggestions?q=vue&ignoreCase=true
```

**新增参数：**
- `ignoreCase` (query, boolean, default=true): 是否忽略大小写

### 5. 错误处理规范

**标准错误响应格式：**
```json
{
  "success": false,
  "error": "TAG_NOT_FOUND",
  "message": "标签不存在"
}
```

**常见错误码：**
- `TAG_NOT_FOUND`: 标签不存在
- `POST_NOT_FOUND`: 文章不存在
- `DUPLICATE_TAG_ALREADY_EXISTS`: 重复标签
- `VALIDATION_ERROR`: 参数验证错误
- `TAG_ALREADY_BOUND_TO_POST`: 标签已绑定到文章
- `TAG_NOT_BOUND_TO_POST`: 标签未绑定到文章

---

## 后端开发大纲

### 1. Service 层开发

#### 1.1 TagService 新增方法

```java
// 文件: src/main/java/wiki/kana/service/TagService.java

/**
 * 不区分大小写搜索标签
 * @param keyword 搜索关键词
 * @return 匹配的标签列表
 */
List<Tag> searchByNameIgnoreCase(String keyword);

/**
 * 智能创建标签：先查找（不区分大小写），找不到则创建
 * @param name 标签名称
 * @param description 标签描述（可选）
 * @param color 标签颜色（可选）
 * @return 现有或新创建的标签
 */
Tag findOrCreateByName(String name, String description, String color);

/**
 * 添加文章到标签关联
 * @param tagId 标签ID
 * @param postId 文章ID
 */
void addPostToTag(Long tagId, Long postId);

/**
 * 从标签移除文章关联
 * @param tagId 标签ID
 * @param postId 文章ID
 */
void removePostFromTag(Long tagId, Long postId);

/**
 * 批量添加文章到标签关联
 * @param tagId 标签ID
 * @param postIds 文章ID列表
 */
void addPostsToTag(Long tagId, List<Long> postIds);

/**
 * 批量从标签移除文章关联
 * @param tagId 标签ID
 * @param postIds 文章ID列表
 */
void removePostsFromTag(Long tagId, List<Long> postIds);
```

#### 1.2 PostService 新增方法

```java
// 文件: src/main/java/wiki/kana/service/PostService.java

/**
 * 设置文章标签（替换当前所有标签）
 * @param postId 文章ID
 * @param tagIds 标签ID列表
 * @return 更新后的文章
 */
Post setPostTags(Long postId, List<Long> tagIds);

/**
 * 添加单个标签到文章
 * @param postId 文章ID
 * @param tagId 标签ID
 * @return 更新后的文章
 */
Post addTagToPost(Long postId, Long tagId);

/**
 * 从文章移除单个标签
 * @param postId 文章ID
 * @param tagId 标签ID
 * @return 更新后的文章
 */
Post removeTagFromPost(Long postId, Long tagId);
```

### 2. Controller 层开发

#### 2.1 TagController 新增接口

```java
// 文件: src/main/java/wiki/kana/controller/TagController.java

/**
 * 智能创建标签接口
 */
@PostMapping("/smart-create")
public ResponseEntity<CommonResponse<TagResponse>> smartCreateTag(
        HttpServletRequest request,
        @RequestBody @Valid TagSmartCreateRequest smartCreateRequest);

/**
 * 获取标签关联文章简要信息
 */
@GetMapping("/{id}/posts-summary")
public ResponseEntity<CommonResponse<Page<PostSummaryResponse>>> getTagPostsSummary(
        @PathVariable Long id,
        @RequestParam(defaultValue = "0") int page,
        @RequestParam(defaultValue = "10") int size,
        @RequestParam(required = false) String status);

/**
 * 批量添加文章到标签
 */
@PostMapping("/{id}/posts")
public ResponseEntity<CommonResponse<Void>> addPostsToTag(
        @PathVariable Long id,
        @RequestBody @Valid TagPostsRequest request,
        HttpServletRequest httpRequest);

/**
 * 批量从标签移除文章
 */
@DeleteMapping("/{id}/posts")
public ResponseEntity<CommonResponse<Void>> removePostsFromTag(
        @PathVariable Long id,
        @RequestBody @Valid TagPostsRequest request,
        HttpServletRequest httpRequest);

// 修改现有搜索接口，添加ignoreCase参数
@GetMapping("/search")  // 修改现有方法
public ResponseEntity<CommonResponse<Page<TagResponse>>> searchTags(
        @RequestParam(required = false) String q,
        @RequestParam(defaultValue = "0") int page,
        @RequestParam(defaultValue = "20") int size,
        @RequestParam(defaultValue = "true") boolean ignoreCase);

// 修改建议接口，添加ignoreCase参数
@GetMapping("/suggestions")  // 修改现有方法
public ResponseEntity<CommonResponse<List<TagResponse>>> suggestTags(
        @RequestParam String q,
        @RequestParam(defaultValue = "8") int limit,
        @RequestParam(defaultValue = "true") boolean ignoreCase);
```

#### 2.2 PostController 新增接口

```java
// 文件: src/main/java/wiki/kana/controller/PostController.java

/**
 * 添加单个标签到文章
 */
@PostMapping("/{id}/tags/{tagId}")
public ResponseEntity<CommonResponse<Void>> addTagToPost(
        @PathVariable Long id,
        @PathVariable Long tagId,
        HttpServletRequest request);

/**
 * 从文章移除单个标签
 */
@DeleteMapping("/{id}/tags/{tagId}")
public ResponseEntity<CommonResponse<Void>> removeTagFromPost(
        @PathVariable Long id,
        @PathVariable Long tagId,
        HttpServletRequest request);

/**
 * 批量设置文章标签
 */
@PutMapping("/{id}/tags")
public ResponseEntity<CommonResponse<PostResponse>> setPostTags(
        @PathVariable Long id,
        @RequestBody @Valid PostTagsRequest request,
        HttpServletRequest httpRequest);
```

### 3. DTO 层开发

#### 3.1 新增 DTO 类

```java
// 文件: src/main/java/wiki/kana/dto/tag/TagSmartCreateRequest.java
@Data
@Validated
public class TagSmartCreateRequest {
    @NotBlank(message = "标签名称不能为空")
    @Size(max = 50, message = "标签名称长度不能超过50个字符")
    private String name;

    @Size(max = 200, message = "标签描述长度不能超过200个字符")
    private String description;

    @Pattern(regexp = "^#[0-9A-Fa-f]{6}$", message = "颜色格式必须是十六进制颜色码")
    private String color;
}

// 文件: src/main/java/wiki/kana/dto/tag/TagPostsRequest.java
@Data
@Validated
public class TagPostsRequest {
    @NotEmpty(message = "文章ID列表不能为空")
    private List<Long> postIds;
}

// 文件: src/main/java/wiki/kana/dto/post/PostTagsRequest.java
@Data
@Validated
public class PostTagsRequest {
    private List<Long> tagIds = new ArrayList<>();
}

// 文件: src/main/java/wiki/kana/dto/post/PostSummaryResponse.java
@Data
@Builder
public class PostSummaryResponse {
    private Long id;
    private String title;
    private String slug;
    private String excerpt;
    private Post.PostStatus status;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;

    // 静态转换方法
    public static PostSummaryResponse fromPost(Post post) {
        return PostSummaryResponse.builder()
                .id(post.getId())
                .title(post.getTitle())
                .slug(post.getSlug())
                .excerpt(post.getExcerpt())
                .status(post.getStatus())
                .createdAt(post.getCreatedAt())
                .updatedAt(post.getUpdatedAt())
                .build();
    }
}
```

### 4. Repository 层开发

#### 4.1 TagRepository 新增查询方法

```java
// 文件: src/main/java/wiki/kana/repository/TagRepository.java

/**
 * 不区分大小写按名称查找标签
 */
Optional<Tag> findByNameIgnoreCase(String name);

/**
 * 不区分大小写按名称模糊搜索
 */
@Query("SELECT t FROM Tag t WHERE LOWER(t.name) LIKE LOWER(CONCAT('%', :keyword, '%'))")
List<Tag> findByNameContainingIgnoreCase(@Param("keyword") String keyword);

/**
 * 检查标签名称是否存在（不区分大小写）
 */
boolean existsByNameIgnoreCase(String name);
```

### 5. 异常处理

#### 5.1 新增自定义异常

```java
// 文件: src/main/java/wiki/kana/exception/TagBindingException.java
public class TagBindingException extends RuntimeException {
    public TagBindingException(String message) {
        super(message);
    }

    public TagBindingException(String message, Throwable cause) {
        super(message, cause);
    }
}
```

### 6. 实现优先级

#### Phase 1: 核心功能（2-3天）
1. **Repository层**: 添加不区分大小写查询方法
2. **TagService**: 实现 `searchByNameIgnoreCase` 和 `findOrCreateByName`
3. **TagController**: 实现 `/smart-create` 接口
4. **DTO**: 创建 `TagSmartCreateRequest`

#### Phase 2: 关联管理（2-3天）
1. **TagService**: 实现文章关联方法
2. **PostService**: 实现标签设置方法
3. **TagController**: 实现关联管理接口
4. **PostController**: 实现标签管理接口
5. **DTO**: 创建请求/响应DTO类

#### Phase 3: 优化完善（1天）
1. 修改现有搜索接口支持ignoreCase
2. 完善异常处理
3. 编写单元测试

---

### 7. 单元测试规划

#### 7.1 Service层测试

```java
// 文件: src/test/java/wiki/kana/service/TagServiceTest.java

@Test
void testSearchByNameIgnoreCase();
@Test
void testFindOrCreateByName_ExistingTag();
@Test
void testFindOrCreateByName_NewTag();
@Test
void testAddPostToTag();
@Test
void testRemovePostFromTag();
@Test
void testAddPostsToTag();
@Test
void testRemovePostsFromTag();
```

```java
// 文件: src/test/java/wiki/kana/service/PostServiceTest.java

@Test
void testSetPostTags();
@Test
void testAddTagToPost();
@Test
void testRemoveTagFromPost();
```

#### 7.2 Controller层测试

```java
// 文件: src/test/java/wiki/kana/controller/TagControllerTest.java

@Test
void testSmartCreateTag();
@Test
void testGetTagPostsSummary();
@Test
void testAddPostsToTag();
@Test
void testRemovePostsFromTag();
@Test
void testSearchTagsIgnoreCase();
```

```java
// 文件: src/test/java/wiki/kana/controller/PostControllerTest.java

@Test
void testAddTagToPost();
@Test
void testRemoveTagFromPost();
@Test
void testSetPostTags();
```